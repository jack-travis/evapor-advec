\documentclass[11pt]{article}
\usepackage[margin=2.5cm]{geometry}
\usepackage{graphicx}
\usepackage{varwidth}
\usepackage{float}			%[H] for "exactly here"
\usepackage{amsfonts}		%Standard maths
\usepackage{amsmath}		%Standard maths
\usepackage{amssymb}		%Standard maths
\usepackage{caption}
\usepackage{listings}
\usepackage{natbib}

\captionsetup[figure]{font=footnotesize}
\linespread{1.3}		%1.5 spacing
\lstset{language=Python,breaklines}		%,showtabs=true,tab=\rightarrowfill

\begin{document}

\thispagestyle{empty}
\title{UNIVERSITY OF READING\\
~\\
Department of Meteorology\\
~\\
On the Representation of Evaporation and Condensation in Weather Models}
\author{Jack Travis}
\maketitle

\section{Abstract}
The main subject is to investigate how evaporation and condensation may behave under advection in a weather model. Of interest are extreme cases where a large amount of evaporation or condensation occurs over a short time/space interval, such as the case of air being advected through a front. In such cases, models may predict more fluid undergoing evaporation or condensation than there is liquid or vapour available to evaporate or condense, leading to invalid values for fluid properties, possibly including instability. The primary subject is to examine and compare different methods of preventing adverse effects from occurring.

\null \vfill
A dissertation submitted in partial fulfilment of the requirement for the MSc degree of Atmosphere, Oceans and Climate.

\newpage
\tableofcontents

\newpage

\section{Motivation}
The topic of this work is the handling of evaporation and condensation (considered as a single process) in weather models: in particular, how a sudden state change of a large amount of fluid, e.g. in passing through a front, can cause instability and/or unphysical values for fluid properties to arise. \\
Ideally, we would like to be know what conditions result in instability, so that changes in how evaporation and condensation are represented in models can be recommended to prevent such issues occuring. \\
DISCUSS WILSON (and SMITH in context thereof) \\
DISCUSS G\&S \\
DISCUSS JAEHN (cite??) \\

\section{Problem}
For the sake of study, an example problem has been constructed in which fluid advects continuously through a region of varying temperature, thus variously evaporating and condensing. In this example problem, the space is one-dimensional in representation, given for convenience a size of $1$ arbitrary space unit. \\
Such fluid properties as air density, air pressure and background fluid velocity are assumed to be approximately even over the domain, as would be generally expected for fluid advection in the horizontal; the only property that varies over the space is temperature. The exact temperature field used by the model was varied experimentally, but most commonly were used a basic ``square'' temperature field and a (marginally) more realistic sloped field, as seen in figure \ref{fig:tempfields} below.
\begin{figure}[H]
\centering
\includegraphics[width=\textwidth]{tempfields.png}
\caption{The two temperature fields that were generally used in runs of the model. The horizontal axis is in arbitrary space units, while the vertical axis is in Kelvins; the upper and lower temperatures are respectively $20^{\circ}$C and $10^{\circ}$C.}
\label{fig:tempfields}
\end{figure}
Both temperature fields are tripartite, having a warmer region of evaporation surrounded by a cooler region of condensation. This roughly simulates the example situation of fluid advecting through a front. \\
As based on an formula taken from \citet[p.~2920]{BF2002} apud \citet{RH1983}, evaporation and condensation are taken to be controlled by the following equation for the concentration of water vapour $r_v$ (and with a similar equation existing for the liquid water concentration $r_l$),
\begin{equation} \label{eq:1}
\frac{\partial r_v}{\partial t}|_{\text{cond}}=\frac{r_{vs} - r_v}{E_r}
\end{equation}
for a constant evaporation/condensation timescale $E_r$, where $r_{vs}$ is the saturation mixing ratio. \\
From the original form of equation \ref{eq:1}, the part of the calculation based on $E_r$ differs in two ways. \\
Firstly, it was originally multiplied by a $\Delta t$ component, such that $\Delta r_v|_{\text{cond}}$ (the change in $r_v$ due to $E_r$ at each timestep) would not be dependent on $\Delta t$, which was done to make stability of the system easier to achieve. For the rate to not vary with timescale is unrealistic, and so here the $\Delta t$ component has been removed. \\
Secondly, $E_r$ is taken in the original source to vary in temperature INSERT EQUATION FROM B\&F: since that would here mean varying $E_r$ over the domain, it has instead taken to be constant (using by default the average temperature over the domain, though the value was varied experimentally). It is $r_{vs}$ which is dependent on $T$, and thus varies over the domain. \\
Between the evaporation/condensation (as per equation \ref{eq:1}) and the advection, and ignoring the limitation described in equation \ref{eq:2}, we can now produce the PDE
\[
\frac{\text{D} r_v}{\text{D} t}=\frac{\partial r_v}{\partial t}|_{\text{cond}}
\]
thus
\begin{equation}
\frac{\partial r_v}{\partial t}+u\frac{\partial r_v}{\partial x}=\frac{r_{vs} - r_v}{E_r} \label{eq:3}
\end{equation}
where the LHS is the advection as a material derivative, and the RHS is the evaporation/condensation as a sink/source term.

\section{Implementation}
We assume that the fluid initially is entirely liquid water, since the fluid would be expected to be mostly liquid within typical temperate values for temperature and pressure. \\
The space is subdivided into 90 spatial cells (thus $\Delta x=1/90$ arbitrary space units), with that number being chosen for the convenience of dividing it into three (as in figure \ref{fig:tempfields}). \\
Model simulations always used a timestep of $\Delta t=0.1$ arbitrary time units. Originally this was because it was necessary to have a small timestep in order for the model to be able to run normally under the exemplar parameter values that were being used during model development; subsequently, the same timestep was used for all simulations for consistency. \\
$r_{vs}$ is taken to vary with $T$ based on
\begin{align}
e_s &= \begin{cases}
0.61078 e^{\frac{21.875T}{T+265.5}} & \text{: $T<0^{\circ}$C} \\
0.61078 e^{\frac{17.27T}{T+237.3}} &
\end{cases} \label{eq:tetens} \\
r_{vs} &= B\frac{e_s}{P-e_s} \label{eq:magic}
\end{align}
using $T$ in degrees Celsius, where $P$ is pressure and $B\approx0.62186$ is the ratio of the molar masses of water and air. (CITE AMBAUM) \\
We note that it is unrealistic to allow evaporation if there is no liquid water remaining in the system, and vice versa, because then $r_v$ or $r_l$ could attain negative values, with this resulting in unstable oscillations. In order to prevent this, the change in fluid concentrations due to evaporation or condensation at each timestep, on the contrary to equation \ref{eq:1}, in implementation is actually taken to be
\begin{equation} \label{eq:2}
\Delta r_v|_{\text{cond}} = \min\left(\Delta t\frac{r_{vs} - r_v}{E_r},r_l\right)
\end{equation}
Because of this dependence on $r_{vs}-r_v$, the steady state with respect to evaporation/condensation is where $r_{vs}=r_v$ (regardless of the value for $r_l$). \\
It is assumed that since the fluid advects unidirectionally across the space from one side to the other, we can have the fluid being spontaneously created on the source side and destroyed on the other. For the implementation, it is assumed that the fluid off the left edge of the grid has the same temperature (and so $r_{vs}$) of the leftmost cell on the grid, and so has
\begin{align}
r_{v,-1} &= r_{vs,0} \label{eq:a} \\
r_{l,-1} &= r_{v,0}+r_{l,0}-r_{vs,0} \label{eq:b}
\end{align}
such that it is in a steady state (as aforementioned in the context of equation \ref{eq:2}) and has the same $r_v+r_l$ as the leftmost cell. \\
For simplicity, here the advection process is represented by a forwards-in-time backwards-in-space (FTBS) finite difference method. Note however that since the advection and evaporation/condensation processes can interact with one another in complex ways; thus, in order to better be able to achieve stability, it is best to keep the two operations separate. We thus end up with the $r_v$ relation
\begin{align} \label{eq:4}
r'_{v,i} &= r_{v,i} + \min\left(\Delta t\frac{r_{vs,i} - r_{v,i}}{E_r},r_{l,i}\right) \\ \label{eq:5}
r''_{v,i} &= r'_{v,i} - c\left(r'_{v,i} - r'_{v,i-1}\right)
\end{align}
and likewise for $r_l$
\begin{align} \label{eq:6}
r'_{l,i} &= r_{l,i} - \min\left(\Delta t\frac{r_{vs,i} - r_{v,i}}{E_r},r_{l,i}\right) \\ \label{eq:7}
r''_{l,i} &= r'_{l,i} - c\left(r'_{l,i} - r'_{l,i-1}\right)
\end{align}
where $r'$ and $r''$ represent operation-intermediate values, $i$ is a spatial index value, and $c=u \Delta t/\Delta x$ is the Courant number. \\
The concern now is how the behaviour of this model varies depending on $E_r$ and $c$. For simplicity, $\Delta t$ and $\Delta x$ are kept constant such that $u$ is the only component of $c$ that is varied.

\section{Numerical analysis of the system}
We can now perform numerical analysis upon the PDE in an attempt to predict its stability. \\
Let us temporarily ignore $r_l$ and focus only on $r_v$. By approximating $r_{vs}$ as uniform over the domain, we can use $S=r_v-r_{vs}$ to rewrite equations \ref{eq:4}, \ref{eq:5}, \ref{eq:6} and \ref{eq:7} as
\begin{align}
S'_i &= S_i - \Delta t\frac{S_i}{E_r}		\nonumber \\
S'_i &= \left(1-\frac{\Delta t}{E_r}\right)S_i	\nonumber \\
S''_i &= S'_i - c\left(S'_i - S'_{i-1}\right)		\nonumber \\
S''_i &= \left(1-c\right)S'_i + cS'_{i-1}		\nonumber \\
S''_i &= \left(1-c\right)\left(1-\frac{\Delta t}{E_r}\right)S_i + c\left(1-\frac{\Delta t}{E_r}\right)S_{i-1}	\label{eq:9}
\end{align}
From this, we take $\epsilon$ to be the error between the model's numerical solution to the PDE and the analytical solution, and assume that since the numerical and analytical solutions solve the PDE, $\epsilon$ must be a solution as well:
\begin{align} \nonumber
\epsilon''_i &= \left(1-c\right)\left(1-\frac{\Delta t}{E_r}\right)\epsilon_i + c\left(1-\frac{\Delta t}{E_r}\right)\epsilon_{i-1} \\
\label{eq:10} \text{i.e.\quad}
\epsilon^{t+\Delta t}_i &= \left(1-c\right)\left(1-\frac{\Delta t}{E_r}\right)\epsilon^t_i
+ c\left(1-\frac{\Delta t}{E_r}\right)\epsilon^t_{i-1}
\end{align}
Furthermore, let us assume that $\epsilon$ can be represented by the Fourier series
\begin{equation} \label{eq:11}
\epsilon = \sum_{\forall k}\left(e^{\alpha t}e^{ikx}\right)
\end{equation}
for some growth rate $\alpha$, and for various wavenumbers $k$ at each $\epsilon_i$, and that each individual summand is itself a solution. Substituting the summands from equation \ref{eq:11} into equation \ref{eq:10} gives us
\begin{align*}
e^{\alpha\left(t+\Delta t\right)}e^{ikx}
&= \left(1-c\right)\left(1-\frac{\Delta t}{E_r}\right)e^{\alpha t}e^{ikx}
+ c\left(1-\frac{\Delta t}{E_r}\right)e^{\alpha t}e^{ik\left(x-\Delta x\right)} \\
e^{\alpha\Delta t}
&= \left(1-c\right)\left(1-\frac{\Delta t}{E_r}\right)
+ c\left(1-\frac{\Delta t}{E_r}\right)e^{-ik\Delta x} \\
e^{\alpha\Delta t}
&= \left(1-\frac{\Delta t}{E_r}\right)\left(1-c+ce^{-ik\Delta x}\right) \\
e^{\alpha\Delta t}
&= \left(1-\frac{\Delta t}{E_r}\right)\left(1-c+c\cos\left(k\Delta x\right)-ic\sin\left(k\Delta x\right)\right)
\end{align*}
In predicting the system's stability, we are interested in how $\epsilon$ grows over time, or equivalently how the summands grow. In fact the growth rate of the summands is simply
\[
\left|\frac{e^{\alpha\left(t+\Delta t\right)}e^{ikx}}{e^{\alpha t}e^{ikx}}\right| = \left|e^{\alpha\Delta t}\right|
\]
and we can ensure stability if the growth rate does not exceed $1$, thus
\begin{align}
\left|e^{\alpha\Delta t}\right|\leq 1 \Leftrightarrow
\left|e^{\alpha\Delta t}\right|^2&\leq 1 \Leftrightarrow
\left(e^{\alpha\Delta t}\right)\left(e^{\alpha\Delta t}\right)^*\leq 1 \nonumber\\
\left(1-\frac{\Delta t}{E_r}\right)^2
\left(1-c+c\cos\left(k\Delta x\right)-ic\sin\left(k\Delta x\right)\right) &
\left(1-c+c\cos\left(k\Delta x\right)+ic\sin\left(k\Delta x\right)\right)\leq 1 \nonumber\\
\left(1-\frac{\Delta t}{E_r}\right)^2\left(1+2(c^2-c)(1-\cos(k\Delta x))\right) &\leq 1 \nonumber\\
1+2(c^2-c)(1-\cos(k\Delta x)) &\leq \frac{E_r^2}{\left(E_r-\Delta t\right)^2}		\text{\quad\quad($\forall k$)} \nonumber\\
1+2(c^2-c)(1-[-1,1]) &\leq \frac{E_r^2}{\left(E_r-\Delta t\right)^2} \nonumber\\
1+2(c^2-c)([0,2]) &\leq \frac{E_r^2}{\left(E_r-\Delta t\right)^2} \nonumber\\
\frac{E_r^2}{\left(E_r-\Delta t\right)^2}-1 &\geq 4K(c^2-c)				\text{\quad\quad($K\in[0,1]$)} \label{eq:stable}
\end{align}
Under the assumption that we want stability to be guaranteed for \emph{all} $K\in[0,1]$, we can reinterpret the RHS of the stability condition as $\max\left(0,4(c^2-c)\right)$. Furthermore, as $E_r$ and $\Delta t$ are both timescales, it is helpful to rewrite them in terms of $A=E_r/\Delta t$. This give us
\begin{align}
\frac{\left(A\Delta t\right)^2}{\left(A\Delta t-\Delta t\right)^2}-1 &\geq \max\left(0,4(c^2-c)\right) \nonumber\\
\left(\frac{A}{A-1}\right)^2 -1 &\geq \max\left(0,4(c^2-c)\right) \nonumber\\
\text{$0\leq c\leq 1$ case:\quad} \left(\frac{A}{A-1}\right)^2 -1 &\geq 0 \nonumber\\
\left(\frac{A}{A-1}\right)^2 &\geq 1 \nonumber\\
A^2 &\geq \left(A-1\right)^2 \nonumber\\
0 &\geq A^2 + 1 - 2A - A^2 \nonumber\\
2A &\geq 1 \nonumber\\
A &\geq \frac{1}{2}.		\label{eq:stab1} \\
\text{$c>1$ case:\quad} \left(\frac{A}{A-1}\right)^2 -1 &\geq 4(c^2-c)		\label{eq:stab4} \\
\left(\frac{A}{A-1}\right)^2 &\geq 4(c^2-c)+1 = 4\left(c-\frac{1}{2}\right)^2 \nonumber \\
\left|\frac{A}{A-1}\right| &\geq 2\left|c-\frac{1}{2}\right| \nonumber \\
\left|\frac{A}{A-1}\right| &\geq 2c-1 \nonumber \\
c &\leq \frac{1}{2}\left(1 + \left|\frac{A}{A-1}\right|\right) 	\label{eq:stab5}
\end{align}
Condition \ref{eq:stab1} informs us that in the case of $c<1$ and $A<1/2$, stability is not guaranteed. It can be expected that this is where evaporation/condensation can produce instabilities (due to sufficiently small $A$ $\Leftrightarrow$ fast evaporation/condensation) that advection cannot necessarily eliminate (due to sufficiently small $c$ $\Leftrightarrow$ slow advection). This will result in unphysical values at best (potentially if instabilities occur at all, regardless of whether they are eliminated or not) and growth without bound at worst. \\
In addition, we find from condition \ref{eq:stab5} that if $c>1$ and $A<1/2$ then
\begin{align*}
\frac{A}{A-1} &< -1 \\
\left|\frac{A}{A-1}\right| &< 1 \\
1 < c \leq \frac{1}{2}\left(1 + \left|\frac{A}{A-1}\right|\right) &< 1
\end{align*}
i.e. $1<c<1$: contradiction. We therefore find that if $A<1/2$ then stability cannot be guaranteed for \emph{any} $c$. For these reasons, it would be ideal to always use $A>1/2$ in practice, even though $A<1/2$ may not necessarily produce any significant instability. \\
In general, we can produce a plot of predicted stability for the system based on the general-case stability condition. In this case, it is helpful to use condition \ref{eq:stable} and produce a plot showing the values of $K$ for which the stability condition holds for given $c$ and $E_r$ values. Such a plot can be seen as figure \ref{fig:stability_pred} below.
\begin{figure}[H]
\centering
\includegraphics[width=\textwidth]{stability_pred.png}
\caption{A plot of the stability of the system as predicted by the analysis above. The colour scale indicates the proportion of values for $K\in[0,1]$ for which the stability condition holds; e.g. in the yellow region, where the proportion is $100\%$, stability is guaranteed by the analysis.}
\label{fig:stability_pred}
\end{figure}
However, this plot alone does not tell us how the system behaves for diverging $c$ and $A$. Condition \ref{eq:stab1} already tells us of the stability for $c\leq 1$, so let us consider the limiting behaviours of condition \ref{eq:stab4}.
\begin{align}
\text{$c>1$ case as $c\to +\infty$:\quad} \left(\frac{A}{A-1}\right)^2 -1 &\geq \lim_{c\to +\infty}\left(4(c^2-c)\right) \nonumber \\
\left(\frac{A}{A-1}\right)^2 -1 &\geq +\infty		\label{eq:stab2} \\
\text{$c>1$ case as $A\to +\infty$:\quad} \lim_{A\to +\infty}\left(\left(\frac{A}{A-1}\right)^2\right)-1 &\geq 4(c^2-c) \nonumber\\
1 - 1 &\geq 4(c^2-c) \nonumber\\
c^2-c &\leq 0 \nonumber\\
c^2 &\leq 1 \Leftrightarrow
c \leq 1.		\label{eq:stab3}
\end{align}
Condition \ref{eq:stab2} is undefined at $A=1$ and false otherwise. This implies that for all $A\neq 1$ (that is, for all $E_r\neq\Delta t$), instability must occur for all $c>c_{\text{min}}$ for some $c_{\text{min}}>1$. As such, there does not exist an $A$ for which stability is guaranteed for all $c$. \\
Condition \ref{eq:stab3} tells us that for any $A>1$ ($\Leftrightarrow E_r>\Delta t$), we can guarantee stability for $c\leq 1$. This is convenient in our case, as realistic values for $E_r$ (as in equation REF) tend to be much larger than our $\Delta t=0.1$. However, weather models typically have much larger timesteps for the sake of computation speed, rendering this advantage moot; in fact, (AS AFOREMENTIONED) models of the kind of \citet{Smith1990} (in which $r_v$ and $r_l$, or equivalents thereto, are not prognostic) typically treat evaporation and condensation as instantaneous because the timescales over which those processes occur are so much smaller than the $\Delta t$ used.

\section{Model results}
To examine simple behaviour of the model, we can see what kind of ``shape'' the system settles into for some example values of $c$ and $E_r$. Such a plot, specifically showing the development of $r_v$ over time, can be seen as figure \ref{fig:samplot} below.
\begin{figure}[H]
\centering
\includegraphics[width=\textwidth]{samplot.png}
\caption{Various plots of $r_v$ over time $t$ for different values of $E_r$ and $c$, showing some exemplary behaviours of the system. Note that the lightest and darkest regions actually go outside the limits of $[-0.01,0.02]$.}
\label{fig:samplot}
\end{figure}
In the example model runs that are stable, $r_v$ approaches a pattern where it has values of approximately $0.0078$ in the colder thirds (of $T=10^{\circ}$C) and approximately $0.0143$ in the warmer middle third (of $T=20^{\circ}$C). The sum of $r_l$ and $r_v$ comes close to $1$ by an error on the order of $10^{-14}$ in the $c=0.5$, $E_r=0.3$ case. \\
DISCUSS OTHER PLOTS \\
However, it is impossible to tell for sure how the model is behaving simply by looking at the shape of $r_v$ at any given timestep. Instead, in order to better tell in particular whether a model run is approaching a steady state, we can provide an energy measure of the fluid, as
\[
R = \sum_{\forall i}\left(r_{v,i}^2+r_{l,i}^2\right)
\]
and track the change in this quantity between timesteps, hereafter $\Delta R$. (CITE PAPER THAT DOES SOMETHING SIMILAR?) Plots showing the behaviour of $\Delta R$ can be seen in figure \ref{fig:exempla} below.
\begin{figure}[H]
\centering
\includegraphics[width=\textwidth]{exempla.png}
\caption{Various plots of the proportion of $\Delta R$ to $R|_{t=0}$ for different values of $E_r$ and $c$. Time runs from $t=0$ until oscillations in $\Delta R$ are negligibly small, as described below by condition \ref{eq:variat}.}
\label{fig:exempla}
\end{figure}
Generally, $\Delta R$ oscillates over time (that is, $R$ steps up and down between timesteps) and always at first increases in magnitude. Thereafter, two variations in behaviour can occur: either the oscillations continue to grow without limit, or $\Delta R$ will begin to decrease in magnitude; and either the oscillations will approach $0$, or will become steady at some finite non-zero value. \\
It is the case of the oscillations approaching $0$ that we desire, so we can investigate how many timesteps it takes for $\Delta R$ to fall in magnitude below some small threshold value. A plot produced using the condition
\begin{equation}
\left|\frac{\Delta R}{R|_{t=0}}\right|<10^{-5}		\label{eq:variat}
\end{equation}
can be seen in figure \ref{fig:stable_real} below.
\begin{figure}[H]
\centering
\includegraphics[width=\textwidth]{stable_real.png}
\caption{A plot showing the first time $t\in(\Delta t,50)$ for which condition \ref{eq:variat} is true, assuming that oscillations less than that value are negligible. White regions indicate that the condition failed to be true before the time limit $t\geq 50$.}
\label{fig:stable_real}
\end{figure}
It is obvious that the boundaries of the dark region (largely of stability) closely match those of the yellow region (of total stability) in figure \ref{fig:stability_pred}. MENTION TWO DIFFERENCES AND STATE LIKELY REASONS

\section{Alternate method}

\newpage
\bibliography{references}
\bibliographystyle{plainnat}

\end{document}